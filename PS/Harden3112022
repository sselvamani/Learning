param (
    [Parameter(Position=0)]
    [string]$Script,
    [Parameter(Position=1)]
    [array]$Harden
)

$appcmd = "c:\windows\system32\inetsrv\appcmd.exe"

Function Setup-Crypto
{
    Write-Host "Setup Crypto..."
    #Make and Enable TLS 1.2 for client and server SCHANNEL communications
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server" -name "Enabled" -value 0xffffffff -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server" -name "DisabledByDefault" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client" -name "Enabled" -value 0xffffffff -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client" -name "DisabledByDefault" -value 0 -PropertyType "DWord" -Force
    # Disable TLS 1.1
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1" -Force | Out-Null
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Server" -Force | Out-Null
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Server" -name "Enabled" -value 0 -PropertyType "DWord" -Force | Out-Null
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Server" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force | Out-Null
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Client" -Force | Out-Null
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Client" -name "Enabled" -value 0 -PropertyType "DWord" -Force | Out-Null
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Client" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force | Out-Null
    # Disable TLS 1.0
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Server" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Server" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Server" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Client" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Client" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Client" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    # Disable SSL 2.0
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 2.0\Server" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 2.0\Server" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 2.0\Server" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 2.0\Client" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 2.0\Client" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 2.0\Client" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    # Disable SSL 3.0
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 3.0\Server" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 3.0\Server" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 3.0\Server" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 3.0\Client" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 3.0\Client" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\SSL 3.0\Client" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    # Disable PCT 1.0
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\PCT 1.0\Server" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\PCT 1.0\Server" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\PCT 1.0\Server" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\PCT 1.0\Client" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\PCT 1.0\Client" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\PCT 1.0\Client" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    # Disable Multi-Protocol Unified Hello
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\Multi-Protocol Unified Hello\Server" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\Multi-Protocol Unified Hello\Server" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\Multi-Protocol Unified Hello\Server" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\Multi-Protocol Unified Hello\Client" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\Multi-Protocol Unified Hello\Client" -name "Enabled" -value 0 -PropertyType "DWord" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\Multi-Protocol Unified Hello\Client" -name "DisabledByDefault" -value 1 -PropertyType "DWord" -Force
    #Disable Weak Cyphers
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\Null" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\Null" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\DES 56/56" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\DES 56/56" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC2 40/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC2 40/128" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC2 56/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC2 56/128" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC2 128/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC2 128/128" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 40/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 40/128" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 56/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 56/128" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 64/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 64/128" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 128/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\RC4 128/128" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\Triple DES 168" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\Triple DES 168" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    #Enable Strong Cyphers
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\AES 128/128" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\AES 128/128" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\AES 256/256" /f
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\AES 256/256" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    #Disable Hashes
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\MD5" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\MD5" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA" -name "Enabled" -value 0 -PropertyType "Dword" -Force
    #Enable Hashes
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA256" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA256" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA384" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA384" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA512" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Hashes\SHA512" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    #Enable Key Exchange Algorithms
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms\Diffie-Hellman" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms\Diffie-Hellman" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms\ECDH" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms\ECDH" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    mkdir "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms\PKCS" -Force
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\KeyExchangeAlgorithms\PKCS" -name "Enabled" -value 0xffffffff -PropertyType "Dword" -Force
    #Eanble only secure ciphers
    $WinVerMajor = ([System.Environment]::OSVersion.Version).Major
    If ($WinVerMajor -eq 6)
    {
        #2012R2
        mkdir "HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\Configuration\SSL\00010002" -Force
        New-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\Configuration\SSL\00010002" -name "Functions" -value "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256_P256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA_P384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384_P384,TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_DSS_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P256,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256_P256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384_P384,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA_P384,TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_DSS_WITH_AES_128_CBC_SHA,TLS_DHE_DSS_WITH_AES_128_CBC_SHA256,TLS_DHE_DSS_WITH_AES_256_CBC_SHA,TLS_DHE_RSA_WITH_AES_256_CBC_SHA" -PropertyType "String" -Force
    }
    ElseIf ($WinVerMajor -ge 10)
    {
        #2016 or Newer
        mkdir "HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\Configuration\SSL\00010002" -Force
        New-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\Configuration\SSL\00010002" -name "Functions" -value "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_DSS_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_DSS_WITH_AES_128_CBC_SHA,TLS_DHE_DSS_WITH_AES_128_CBC_SHA256,TLS_DHE_DSS_WITH_AES_256_CBC_SHA,TLS_DHE_RSA_WITH_AES_256_CBC_SHA" -PropertyType "String" -Force
    }
    Write-Host "Crypto setup completed"

}

Function Set-LocalSecurityPolicy
{
    Write-Host "Setting local security policy..."
    $SecPolicy = '[Unicode]
    Unicode=yes
    [System Access]
    MinimumPasswordAge = 1
    MaximumPasswordAge = 90
    MinimumPasswordLength = 12
    PasswordComplexity = 1
    PasswordHistorySize = 24
    LockoutBadCount = 3
    ResetLockoutCount = 120
    LockoutDuration = -1
    RequireLogonToChangePassword = 0
    ForceLogoffWhenHourExpire = 0
    NewGuestName = "Guest"
    ClearTextPassword = 0
    LSAAnonymousNameLookup = 0
    EnableAdminAccount = 1
    EnableGuestAccount = 0
    [Event Audit]
    AuditSystemEvents = 1
    AuditLogonEvents = 3
    AuditObjectAccess = 1
    AuditPrivilegeUse = 1
    AuditPolicyChange = 1
    AuditAccountManage = 3
    AuditProcessTracking = 1
    AuditDSAccess = 1
    AuditAccountLogon = 3
    [Registry Values]
    MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Setup\RecoveryConsole\SecurityLevel=4,0
    MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Setup\RecoveryConsole\SetCommand=4,0
    MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\AllocateDASD=1,"0"
    MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\CachedLogonsCount=1,"10"
    MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\ForceUnlockLogon=4,0
    MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\PasswordExpiryWarning=4,5
    MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\ScRemoveOption=1,"0"
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorAdmin=4,5
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorUser=4,3
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\DisableCAD=4,0
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\DontDisplayLastUserName=4,1
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableInstallerDetection=4,1
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA=4,1
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableSecureUIAPaths=4,1
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableUIADesktopToggle=4,0
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableVirtualization=4,1
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken=4,0
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters\SupportedEncryptionTypes=4,2147483644
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\LegalNoticeCaption=1,""
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\LegalNoticeText=7,
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\PromptOnSecureDesktop=4,1
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ScForceOption=4,0
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ShutdownWithoutLogon=4,0
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\UndockWithoutLogon=4,1
    MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ValidateAdminCodeSignatures=4,0
    MACHINE\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers\AuthenticodeEnabled=4,0
    MACHINE\System\CurrentControlSet\Control\Lsa\AuditBaseObjects=4,0
    MACHINE\System\CurrentControlSet\Control\Lsa\CrashOnAuditFail=4,0
    MACHINE\System\CurrentControlSet\Control\Lsa\DisableDomainCreds=4,0
    MACHINE\System\CurrentControlSet\Control\Lsa\EveryoneIncludesAnonymous=4,0
    MACHINE\System\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy\Enabled=4,0
    MACHINE\System\CurrentControlSet\Control\Lsa\ForceGuest=4,0
    MACHINE\System\CurrentControlSet\Control\Lsa\FullPrivilegeAuditing=3,0
    MACHINE\System\CurrentControlSet\Control\Lsa\LimitBlankPasswordUse=4,1
    MACHINE\System\CurrentControlSet\Control\Lsa\LmCompatibilityLevel=4,5
    MACHINE\System\CurrentControlSet\Control\Lsa\MSV1_0\NTLMMinClientSec=4,536870912
    MACHINE\System\CurrentControlSet\Control\Lsa\MSV1_0\NTLMMinServerSec=4,536870912
    MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash=4,1
    MACHINE\System\CurrentControlSet\Control\Lsa\RestrictAnonymous=4,1
    MACHINE\System\CurrentControlSet\Control\Lsa\RestrictAnonymousSAM=4,1
    MACHINE\System\CurrentControlSet\Control\Lsa\RestrictRemoteSAM=1,"O:BAG:BAD:(A;;RC;;;BA)"
    MACHINE\System\CurrentControlSet\Control\Lsa\SCENoApplyLegacyAuditPolicy=4,1
    MACHINE\System\CurrentControlSet\Control\Lsa\UseMachineId=4,1
    MACHINE\System\CurrentControlSet\Control\Print\Providers\LanMan Print Services\Servers\AddPrinterDrivers=4,1
    MACHINE\System\CurrentControlSet\Control\SecurePipeServers\Winreg\AllowedExactPaths\Machine=7,System\CurrentControlSet\Control\ProductOptions,System\CurrentControlSet\Control\Server Applications,Software\Microsoft\Windows NT\CurrentVersion
    MACHINE\System\CurrentControlSet\Control\SecurePipeServers\Winreg\AllowedPaths\Machine=7,System\CurrentControlSet\Control\Print\Printers,System\CurrentControlSet\Services\Eventlog,Software\Microsoft\OLAP Server,Software\Microsoft\Windows NT\CurrentVersion\Print,Software\Microsoft\Windows NT\CurrentVersion\Windows,System\CurrentControlSet\Control\ContentIndex,System\CurrentControlSet\Control\Terminal Server,System\CurrentControlSet\Control\Terminal Server\UserConfig,System\CurrentControlSet\Control\Terminal Server\DefaultUserConfiguration,Software\Microsoft\Windows NT\CurrentVersion\Perflib,System\CurrentControlSet\Services\SysmonLog
    MACHINE\System\CurrentControlSet\Control\Session Manager\Kernel\ObCaseInsensitive=4,1
    MACHINE\System\CurrentControlSet\Control\Session Manager\Memory Management\ClearPageFileAtShutdown=4,0
    MACHINE\System\CurrentControlSet\Control\Session Manager\ProtectionMode=4,1
    MACHINE\System\CurrentControlSet\Control\Session Manager\SubSystems\optional=7,
    MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\AutoDisconnect=4,15
    MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\EnableForcedLogOff=4,1
    MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\EnableSecuritySignature=4,0
    MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\NullSessionShares=7,
    MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\RequireSecuritySignature=4,0
    MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\RestrictNullSessAccess=4,1
    MACHINE\System\CurrentControlSet\Services\LanmanWorkstation\Parameters\EnablePlainTextPassword=4,0
    MACHINE\System\CurrentControlSet\Services\LanmanWorkstation\Parameters\EnableSecuritySignature=4,1
    MACHINE\System\CurrentControlSet\Services\LanmanWorkstation\Parameters\RequireSecuritySignature=4,0
    MACHINE\System\CurrentControlSet\Services\LDAP\LDAPClientIntegrity=4,1
    MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\DisablePasswordChange=4,0
    MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\MaximumPasswordAge=4,30
    MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\RequireSignOrSeal=4,1
    MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\RequireStrongKey=4,1
    MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\SealSecureChannel=4,1
    MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters\SignSecureChannel=4,1
    [Privilege Rights]
    SeNetworkLogonRight = *S-1-1-0,*S-1-5-32-544,*S-1-5-32-545,*S-1-5-32-551
    SeBackupPrivilege = *S-1-5-32-544,*S-1-5-32-551
    SeChangeNotifyPrivilege = *S-1-1-0,*S-1-5-19,*S-1-5-20,*S-1-5-32-544,*S-1-5-32-545,*S-1-5-32-551
    SeSystemtimePrivilege = *S-1-5-19,*S-1-5-32-544
    SeCreatePagefilePrivilege = *S-1-5-32-544
    SeDebugPrivilege = *S-1-5-32-544
    SeRemoteShutdownPrivilege = *S-1-5-32-544
    SeAuditPrivilege = *S-1-5-19,*S-1-5-20
    SeIncreaseQuotaPrivilege = *S-1-5-19,*S-1-5-20,*S-1-5-32-544
    SeIncreaseBasePriorityPrivilege = *S-1-5-32-544
    SeLoadDriverPrivilege = *S-1-5-32-544
    SeBatchLogonRight = *S-1-5-32-544,*S-1-5-32-551,*S-1-5-32-559
    SeServiceLogonRight = *S-1-5-80-0
    SeInteractiveLogonRight = *S-1-5-32-544,*S-1-5-32-545,*S-1-5-32-551
    SeSecurityPrivilege = *S-1-5-32-544
    SeSystemEnvironmentPrivilege = *S-1-5-32-544
    SeProfileSingleProcessPrivilege = *S-1-5-32-544
    SeSystemProfilePrivilege = *S-1-5-32-544,*S-1-5-80-3139157870-2983391045-3678747466-658725712-1809340420
    SeAssignPrimaryTokenPrivilege = *S-1-5-19,*S-1-5-20
    SeRestorePrivilege = *S-1-5-32-544,*S-1-5-32-551
    SeShutdownPrivilege = *S-1-5-32-544,*S-1-5-32-551
    SeTakeOwnershipPrivilege = *S-1-5-32-544
    SeDenyBatchLogonRight = *S-1-5-32-546
    SeDenyServiceLogonRight = *S-1-5-32-546
    SeDenyInteractiveLogonRight = *S-1-5-32-546
    SeUndockPrivilege = *S-1-5-32-544
    SeManageVolumePrivilege = *S-1-5-32-544
    SeRemoteInteractiveLogonRight = *S-1-5-32-544,*S-1-5-32-555
    SeDenyRemoteInteractiveLogonRight = *S-1-5-32-546
    SeImpersonatePrivilege = *S-1-5-19,*S-1-5-20,*S-1-5-32-544,*S-1-5-6
    SeCreateGlobalPrivilege = *S-1-5-19,*S-1-5-20,*S-1-5-32-544,*S-1-5-6
    SeIncreaseWorkingSetPrivilege = *S-1-5-32-545
    SeTimeZonePrivilege = *S-1-5-19,*S-1-5-32-544
    SeCreateSymbolicLinkPrivilege = *S-1-5-32-544
    SeDelegateSessionUserImpersonatePrivilege = *S-1-5-32-544
    [Version]
    signature="$CHICAGO$"
    Revision=1'

    $AuditPol = 'Machine Name,Policy Target,Subcategory,Subcategory GUID,Inclusion Setting,Exclusion Setting,Setting Value
    ,System,Audit Credential Validation,{0cce923f-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Kerberos Authentication Service,{0cce9242-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Kerberos Service Ticket Operations,{0cce9240-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Other Account Logon Events,{0cce9241-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Application Group Management,{0cce9239-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Computer Account Management,{0cce9236-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Distribution Group Management,{0cce9238-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Other Account Management Events,{0cce923a-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Security Group Management,{0cce9237-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit User Account Management,{0cce9235-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit PNP Activity,{0cce9248-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Process Creation,{0cce922b-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Logoff,{0cce9216-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Logon,{0cce9215-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Other Logon/Logoff Events,{0cce921c-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Special Logon,{0cce921b-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Removable Storage,{0cce9245-69ae-11d9-bed3-505054503030},Success and Failure,,3
    ,System,Audit Audit Policy Change,{0cce922f-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Authentication Policy Change,{0cce9230-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Authorization Policy Change,{0cce9231-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Other Policy Change Events,{0cce9234-69ae-11d9-bed3-505054503030},Success,,1
    ,System,Audit Non Sensitive Privilege Use,{0cce9229-69ae-11d9-bed3-505054503030},Success,,1'
    
    If (Test-Path "C:\Windows\security\audit\audit.csv" -eq $false -and Test-Path "C:\Windows\System32\GroupPolicy\Machine\microsoft\windows nt\audit\audit.csv" -eq $false)
    {
        New-Item C:\temp\ -ItemType Directory
        Add-Content -Path C:\temp\secimport.inf -Value $SecPolicy
        secedit /import /db C:\temp\secedit.sdb /cfg "C:\temp\secimport.inf"
        secedit /configure /db C:\temp\secedit.sdb
        gpupdate /force
        New-Item "C:\Windows\System32\GroupPolicy\Machine\microsoft\windows nt\audit\" -ItemType Directory -Force
        Add-Content -Path "C:\Windows\security\audit\audit.csv" -Value $AuditPol
        Add-Content -Path "C:\Windows\System32\GroupPolicy\Machine\microsoft\windows nt\audit\audit.csv" -Value $AuditPol
        Remove-Item "C:\temp\" -Recurse
        Write-Host "Local security policy set"
    }
    Else
    {
        Write-Host "Local security policy skipped" -ForegroundColor Red
    }
}

Function Harden-.Net
{
    Write-Host "Hardening crypto for all .Net versions..."
    $NetVers32 = (Get-ChildItem -Path "HKLM:\SOFTWARE\WOW6432Node\Microsoft\.NETFramework" | Where-Object {$_.Name -match "v\d"}).Name
    ForEach ($NetVer32 in $NetVers32)
    {
        $NetVer32 = $NetVer32 -replace "HKEY_LOCAL_MACHINE","HKLM:"
        $ver = (New-ItemProperty -Path $NetVer32 -Name "SchUseStrongCrypto" -Value 1 -PropertyType "Dword" -Force).PSChildName
        $ver2 = (New-ItemProperty -Path $NetVer32 -Name "SystemkdirefaultTlsVersions" -Value 1 -PropertyType "Dword" -Force).PSChildName
        Write-Host "Hardened crypto for .Net 32 bit $ver"
    }
    $NetVers64 = (Get-ChildItem -Path "HKLM:\SOFTWARE\Microsoft\.NETFramework" | Where-Object {$_.Name -match "v\d"}).Name
    ForEach ($NetVer64 in $NetVers64)
    {
        $NetVer64 = $NetVer64 -replace "HKEY_LOCAL_MACHINE","HKLM:"
        $ver = (New-ItemProperty -Path $NetVer64 -Name "SchUseStrongCrypto" -Value 1 -PropertyType "Dword" -Force).PSChildName
        $ver2 = (New-ItemProperty -Path $NetVer32 -Name "SystemkdirefaultTlsVersions" -Value 1 -PropertyType "Dword" -Force).PSChildName
        Write-Host "Hardened crypto for .Net 64 bit $ver"
    }
    Write-Host "All .Net versions crypto have been hardened"
}

Function Harden-IIS
{
    Write-Host "Hardening IIS..."        
    If (Test-Path $appcmd)
    {
        & $appcmd set config /section:requestFiltering /requestLimits.maxAllowedContentLength:30000000
        & $appcmd set config /section:requestFiltering /requestLimits.maxUrl:2048
        & $appcmd set config /section:requestFiltering /requestLimits.maxQueryString:1024
        & $appcmd set config /section:requestFiltering /allowDoubleEscaping:true
        & $appcmd set config /section:requestFiltering /+"verbs.[verb='GET',allowed='true']"
        & $appcmd set config /section:requestFiltering /+"verbs.[verb='POST',allowed='true']"
        & $appcmd set config /section:requestFiltering /+"verbs.[verb='HEAD',allowed='true']"
        & $appcmd set config /section:requestFiltering /+"verbs.[verb='TRACE',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"verbs.[verb='DEBUG',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"verbs.[verb='OPTIONS',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.htw',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.exe',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.bat',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.cmkdir',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.com',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.ini',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.log',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.pol',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.dat',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.reg',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.ida',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.idq',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.htr',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.idc',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.shtm',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.shtml',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.stm',allowed='false']"
        & $appcmd set config /section:requestFiltering /+"fileExtensions.[fileExtension='.printer',allowed='false']"
        & $appcmd set config /section:system.webServer/security/requestFiltering /+"denyUrlSequences.[sequence='..']"
        & $appcmd set config /section:system.webServer/security/requestFiltering /+"denyUrlSequences.[sequence='./']"
        & $appcmd set config /section:system.webServer/security/requestFiltering /+"denyUrlSequences.[sequence='\']"
        & $appcmd set config /section:system.webServer/security/requestFiltering /+"denyUrlSequences.[sequence=':']"
        & $appcmd set config /section:system.webServer/security/requestFiltering /+"denyUrlSequences.[sequence='%']"
        & $appcmd set config /section:system.webServer/security/requestFiltering /+"denyUrlSequences.[sequence='&']"
        & $appcmd set config /section:httpProtocol /+"customHeaders.[name='X-Frame-Options',value='SAMEORIGIN']"
        & $appcmd set config /section:system.webServer/directoryBrowse /enabled:false
        Write-Host "IIS has been hardened"
    }
    Else
    {
        Write-Host "IIS is not installed"
    }
}

Function Secure-IE
{
    Write-Host "Securing IE"
    mkdir "HKLM:\SOFTWARE\Microsoft\Internet Explorer\MAIN\FeatureControl\FEATURE_ALLOW_USER32_EXCEPTION_HANDLER_HARDENING" -Force
    New-ItemProperty -path "HKLM:\SOFTWARE\Microsoft\Internet Explorer\MAIN\FeatureControl\FEATURE_ALLOW_USER32_EXCEPTION_HANDLER_HARDENING" -name "iexplore.exe" -value 1 -PropertyType "Dword" -Force
    mkdir "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Internet Explorer\MAIN\FeatureControl\FEATURE_ALLOW_USER32_EXCEPTION_HANDLER_HARDENING" -Force
    New-ItemProperty -path "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Internet Explorer\MAIN\FeatureControl\FEATURE_ALLOW_USER32_EXCEPTION_HANDLER_HARDENING" -name "iexplore.exe" -value 1 -PropertyType "Dword" -Force
    mkdir "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Force
    New-ItemProperty -path "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -name "iexplore.exe" -value 1 -PropertyType "Dword" -Force
    mkdir "HKLM:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -Force
    New-ItemProperty -path "HKLM:\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_ENABLE_PRINT_INFO_DISCLOSURE_FIX" -name "iexplore.exe" -value 1 -PropertyType "Dword" -Force
    Write-Host "Securing IE complete"
}

Function Enable-SpecMeltFix
{
    Write-Host "Enabling Specter and Meltdown fix..."
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -name "FeatureSettingsOverride" -value 0 -PropertyType "Dword" -Force -ErrorAction SilentlyContinue
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -name "FeatureSettingsOverrideMask" -value 3 -PropertyType "Dword" -Force -ErrorAction SilentlyContinue
    Write-Host "Specter and Meltdown fix enabled"
}

Function Enable-SMBSigning
{
    Write-Host "Enabling SMB Signing"
    New-ItemProperty -path "HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters" -name "RequireSecuritySignature" -value 1 -PropertyType "Dword" -Force
    Write-Host "SMB signing enabled"
}

Function Disable-LM
{
    Write-Host "Disabling LM & NTLMv1"
    New-ItemProperty -path "HKLM:\System\CurrentControlSet\Control\Lsa" -name "LmCompatibilityLevel" -value 5 -PropertyType "Dword" -Force
    Write-Host "LM & NTLMv1 disabled"        
}

Function Disable-SMBv1
{
    Write-Host "Disabling SMBv1"
    Set-SmbServerConfiguration -EnableSMB1Protocol $false -Force
    Remove-WindowsFeature -Name FS-SMB1
    Write-Host "SMBv1 Disabled"
}

Function Disable-SMBv3Compression
{
    Write-Host "Disabling SMBv3 Compression"
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -name "DisableCompression" -value 1 -PropertyType "Dword" -Force
    Write-Host "SMBv3 Compression Disabled"        
}

Function Disable-NetBios
{
    Write-Host "Disabling NetBIOS"
    set-itemproperty "HKLM:\SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces\tcpip*" -Name "NetbiosOptions" -Value 2
    Write-Host "NetBIOS Disabled"
}

Function Disable-PointAndPrint
{
    Write-Host "Checking Point and Print"
    If ($true -eq (Test-Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"))
    {
        Set-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "NoWarningNoElevationOnInstall" -Value 0
        Set-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "UpdatePromptSettings" -Value 0
        Write-Host "Point and Print Hardened"
    }
    Else
    {
        Write-Host "Point and Print not used"
    }
}

Function RDP-Cert
{
    Write-Host "Fixing RDP Cert"
    #Get server name
    $computer = [System.Net.Dns]::GetHostByName(($env:computerName))
    $name = $computer.HostName
    #Gen new cert
    $cert = New-SelfSignedCertificate -DnsName $name -CertStoreLocation cert:\LocalMachine\My
    #Get thumbprint of new cert
    $thumb = $cert.Thumbprint
    #Apply cert for RDP
    wmic /namespace:\\root\cimv2\TerminalServices PATH Win32_TSGeneralSetting Set SSLCertificateSHA1Hash="$thumb"
    Write-Host "RDP Cert Fixed"
}

Function Enable-RDP-NLA
{
    Write-Host "Enabling RDP NLA"
    New-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -name "UserAuthentication" -value 1 -PropertyType "Dword" -Force
    Write-Host "RDP NLA Enabled"
}

Function Disable-LLMNR
{
    Write-Host "Disabling LLMNR"
    mkdir "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient" -Force
    New-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient" -name "EnableMulticast" -value 1 -PropertyType "Dword" -Force
    Write-Host "LLMNR Disabled"
}

Function Block-Unicast
{
    Write-Host "Blocking Unicast"
    New-ItemProperty -path "HKLM:\SOSOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile" -name "DisableUnicastResponsesToMulticastBroadcast" -value 1 -PropertyType "Dword" -Force
    New-ItemProperty -path "HKLM:\SOSOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile" -name "DisableUnicastResponsesToMulticastBroadcast" -value 1 -PropertyType "Dword" -Force
    New-ItemProperty -path "HKLM:\SOSOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile" -name "DisableUnicastResponsesToMulticastBroadcast" -value 1 -PropertyType "Dword" -Force
    Write-Host "Unicast Blocked"
}

If ($Script -ne "y")
{
    $ObjCrypto = New-Object -TypeName psobject
    Add-Member -InputObject $ObjCrypto -MemberType NoteProperty -Name Name -Value "Crypto"
    $ObjDotNet = New-Object -TypeName psobject
    Add-Member -InputObject $ObjDotNet -MemberType NoteProperty -Name Name -Value ".Net"
    $ObjIIS = New-Object -TypeName psobject
    Add-Member -InputObject $ObjIIS -MemberType NoteProperty -Name Name -Value "IIS"
    $ObjRDP = New-Object -TypeName psobject
    Add-Member -InputObject $ObjRDP -MemberType NoteProperty -Name Name -Value "RDP"
    $ObjSMB = New-Object -TypeName psobject
    Add-Member -InputObject $ObjSMB -MemberType NoteProperty -Name Name -Value "SMB"
    $ObjAll = New-Object -TypeName psobject
    Add-Member -InputObject $ObjAll -MemberType NoteProperty -Name Name -Value "All"


    $ObjAHardenroup = @($ObjCrypto,$ObjDotNet,$ObjIIS,$ObjRDP,$ObjSMB,$ObjAll)
    $Harden = ($ObjAHardenroup | Out-GridView -Title "Select what to Harden" -PassThru).Name
    If ($null -eq $Harden)
    {
        Write-Host "No selection made."
        Break
    }
}
ElseIf ($null -eq $Harden)
{
    $Harden = "All"
}

If ($Harden -contains "Crypto")
{
    Setup-Crypto | Out-Null
}
If ($Harden -contains ".Net")
{
    Harden-.Net | Out-Null
}
If ($Harden -contains "IIS")
{
    Harden-IIS | Out-Null
}
If ($Harden -contains "RDP")
{
    RDP-Cert
    Enable-RDP-NLA | Out-Null
}
If ($Harden -contains "SMB")
{
    Enable-SMBSigning | Out-Null
    Disable-SMBv1 | Out-Null
    Disable-SMBv3Compression | Out-Null
}
If ($Harden -contains "All")
{
    Setup-Crypto | Out-Null
    Set-LocalSecurityPolicy | Out-Null
    Harden-.Net | Out-Null
    Harden-IIS | Out-Null
    Secure-IE | Out-Null
    Enable-SpecMeltFix | Out-Null
    Enable-SMBSigning | Out-Null
    Disable-LM | Out-Null
    Disable-SMBv1 | Out-Null
    Disable-SMBv3Compression | Out-Null
    RDP-Cert | Out-Null
    Enable-RDP-NLA | Out-Null
    Disable-NetBios | Out-Null
    Disable-PointAndPrint | Out-Null
    Disable-LLMNR | Out-Null
    #Block-Unicast | Out-Null
}